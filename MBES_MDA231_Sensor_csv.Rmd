---
title: "BE Sensor analysis: MDA231/MBES"
author: "Luke Dow & Henri Schmidt"
date: "11/16/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This is the pipeline fo the analysis of base editing sensor count data generated by bowtie alignment. This approach uses multiple reference alignments that iteratively measure C>T, C>A, C>G modification of target cytosines. Indels are calculated by subtracting all reads of the expected length (guide-scaffold-5'flank-target-3'flank), from the number of total reads that match the guide-scaffold-5'flank. 

First, load the required packages:

```{r echo=TRUE, message=FALSE, warning=FALSE}
library(dplyr)
library(tidyverse)
library(ggplot2)
library(viridis)
library(ggpubr)
library(cowplot)
library(gganimate)
library(readxl)
library(purrr)
library(stringr)

```

<p style="font-family: Arial; font-size:18pt; font-style:bold">
    Import transcript data
</p>
Import each of the tables containing alignment counts for each reference. The easiest way to do this is to set the working directory to the folder containing the relevant .txt files and import and rename columns using a loop:


```{r echo=TRUE, message=FALSE, warning=FALSE}
setwd("~/Box Sync/BE_sensor/MDA231/results/")
# Create list of file names
filenames <- gsub("\\.csv$","", list.files(pattern="\\.csv$"))
# Run import for loop
for(i in filenames){
  assign(i, read.csv(paste(i, ".csv", sep="")))
}
```

Next, import the metadata ("variables") associated with each of the guide_IDs

```{r echo=TRUE, message=FALSE, warning=FALSE}
MBES_variables <- read_excel("~/Box Sync/BE_sensor/Library_cloning/V4_v5/MBESv4_revised_whitelist.xlsx", sheet = "variables")
MBES_variables <- MBES_variables[,c(1:14)]
```

<p style="font-family: Arial; font-size:18pt; font-style:bold">
    Process the count data
</p>
The raw count data for each replicate is merged into a single dataframe and normalized to the total read counts for each guide by calculating "precent editing" for each type of editing event. The mean of each replicate is calculated. Where needed, some duplicate guides are removed as they cannot be mapped accurately.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Calculate mean percentages for TARGET data
MDA231_MBES_CAS9$percent_tCT = (MDA231_MBES_CAS9$percent_tCT_REP1 + MDA231_MBES_CAS9$percent_tCT_REP2)/2
MDA231_MBES_CAS9$percent_tCTN = (MDA231_MBES_CAS9$percent_tCTN_REP1 + MDA231_MBES_CAS9$percent_tCTN_REP2)/2
MDA231_MBES_CAS9$percent_tCAN = (MDA231_MBES_CAS9$percent_tCAN_REP1 + MDA231_MBES_CAS9$percent_tCAN_REP2)/2
MDA231_MBES_CAS9$percent_tCGN = (MDA231_MBES_CAS9$percent_tCGN_REP1 + MDA231_MBES_CAS9$percent_tCGN_REP2)/2
MDA231_MBES_CAS9$percent_indel = (MDA231_MBES_CAS9$percent_indel_REP1 + MDA231_MBES_CAS9$percent_indel_REP2)/2
MDA231_MBES_CAS9$percent_editing = (MDA231_MBES_CAS9$percent_tCTN + MDA231_MBES_CAS9$percent_tCGN +
                                          MDA231_MBES_CAS9$percent_tCAN + MDA231_MBES_CAS9$percent_indel)
MDA231_MBES_CAS9$percent_BE = (MDA231_MBES_CAS9$percent_tCTN + MDA231_MBES_CAS9$percent_tCGN +
                                          MDA231_MBES_CAS9$percent_tCAN)
# Calculate mean percentages for ALL data
MDA231_MBES_CAS9_ALL$percent_tCTN = (MDA231_MBES_CAS9_ALL$percent_tCTN_REP1 + MDA231_MBES_CAS9_ALL$percent_tCTN_REP2)/2
MDA231_MBES_CAS9_ALL$percent_tCAN = (MDA231_MBES_CAS9_ALL$percent_tCAN_REP1 + MDA231_MBES_CAS9_ALL$percent_tCAN_REP2)/2
MDA231_MBES_CAS9_ALL$percent_tCGN = (MDA231_MBES_CAS9_ALL$percent_tCGN_REP1 + MDA231_MBES_CAS9_ALL$percent_tCGN_REP2)/2
MDA231_MBES_CAS9_ALL$percent_BE = (MDA231_MBES_CAS9_ALL$percent_tCTN + MDA231_MBES_CAS9_ALL$percent_tCGN +
                                          MDA231_MBES_CAS9_ALL$percent_tCAN)
```

<p style="font-family: Arial; font-size:18pt; font-style:bold">
    Filter and merge the data
</p>
Data tables are filtered to retain only those guides that contain at least 100 reads in each of the replicates. Metadata ("variables") can be appended to the tables for later plotting purposes

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Filter to 100+ reads/guide and remove replicate data
MBES_CAS9_filtered <- MDA231_MBES_CAS9 %>% filter(total_REP1 > 99 & total_REP2 >99)
MBES_CAS9_ALL_filtered <- MDA231_MBES_CAS9_ALL %>% filter(total_REP1 > 99 & total_REP2 >99)
MBES_CAS9_mean <- MBES_CAS9_filtered[ ,-c(2:23)]
MBES_CAS9_ALL_mean <- MBES_CAS9_ALL_filtered[ ,-c(5:22)]
MBES_CAS9_ALL_mean <- MBES_CAS9_ALL_mean[ ,c(1,5:8,2,3,4)]
# Create separate mean file, rename columns, add variable and enzyme annoation
MBES_CAS9_mean_ann <- MBES_CAS9_filtered[ ,-c(2:23)]
MBES_CAS9_mean_ann <- list(MBES_CAS9_mean_ann,MBES_variables) %>% 
  reduce(full_join, by = 'guide_ID')
MBES_CAS9_mean_ann$enzyme <- "CAS9"
MBES_CAS9_ALL_mean$enzyme <- "CAS9"
MBES_CAS9_mean_ann$cell_line <- "MDA231"
MBES_CAS9_ALL_mean$cell_line <- "MDA231"
# Split by editing type
MBES_CAS9_any_editing <- MBES_CAS9_mean_ann[,-c(2,3,4,5,7)]
names(MBES_CAS9_any_editing)[2] <- "editing"
MBES_CAS9_any_editing$editing_type <- "all"
MBES_CAS9_tCTN <- MBES_CAS9_mean_ann[,-c(3,4,5,6,7)]
names(MBES_CAS9_tCTN)[2] <- "editing"
MBES_CAS9_tCTN$editing_type <- "C>T"
MBES_CAS9_tCAN <- MBES_CAS9_mean_ann[,-c(2,4,5,6,7)]
names(MBES_CAS9_tCAN)[2] <- "editing"
MBES_CAS9_tCAN$editing_type <- "C>A"
MBES_CAS9_tCGN <- MBES_CAS9_mean_ann[,-c(2,3,5,6,7)]
names(MBES_CAS9_tCGN)[2] <- "editing"
MBES_CAS9_tCGN$editing_type <- "C>G"
MBES_CAS9_stack <- rbind(MBES_CAS9_tCTN,MBES_CAS9_tCAN,MBES_CAS9_tCGN)
MBES_CAS9_stack <- MBES_CAS9_stack[complete.cases(MBES_CAS9_stack), ]

# Add PAM_class, nucleotide context and cytosine position information to ALL data
MBES_CAS9_ALL_mean$PAM_class <- ifelse(grepl('GG$', MBES_CAS9_ALL_mean$PAM), "NGG", 
                         ifelse(grepl('GT$', MBES_CAS9_ALL_mean$PAM), "NGT",
                                ifelse(grepl('GC$', MBES_CAS9_ALL_mean$PAM), "NGC",
                                       ifelse(grepl('GA$', MBES_CAS9_ALL_mean$PAM), "NGA",
                                              ifelse(grepl('AG$', MBES_CAS9_ALL_mean$PAM), "NAG",
                                                     ifelse(grepl('TG$', MBES_CAS9_ALL_mean$PAM), "NNG",
                                                            ifelse(grepl('CG$', MBES_CAS9_ALL_mean$PAM), "NNG",
                                                                   ifelse(grepl('^GA', MBES_CAS9_ALL_mean$PAM), "GAN", "other"))))))))
colnames(MBES_CAS9_ALL_mean)[8] <- "nucleotide_context"
MBES_CAS9_ALL_mean$dinucleotide_context <- substr(MBES_CAS9_ALL_mean$nucleotide_context, 2,3)
MBES_CAS9_ALL_mean$trinucleotide_context <- substr(MBES_CAS9_ALL_mean$nucleotide_context, 2,4)
MBES_CAS9_ALL_mean$adj_cytosine_position <- ifelse(MBES_CAS9_ALL_mean$cytosine_position <10, MBES_CAS9_ALL_mean$cytosine_position -10, MBES_CAS9_ALL_mean$cytosine_position -9)
MBES_CAS9_ALL_mean$guide_ID_temp <- as.factor(paste(MBES_CAS9_ALL_mean$guide_ID, MBES_CAS9_ALL_mean$cytosine_position, sep = "_"))
MBES_CAS9_ALL_mean$guide_ID <- NULL
MBES_CAS9_ALL_mean <- MBES_CAS9_ALL_mean[ ,c(14,1:13)]
colnames(MBES_CAS9_ALL_mean)[1] <- "guide_ID"
# Split by editing type
MBES_CAS9_ALL_BE <- MBES_CAS9_ALL_mean[,-c(2,3,4)]
names(MBES_CAS9_ALL_BE)[2] <- "editing"
MBES_CAS9_ALL_BE$editing_type <- "BE"
MBES_CAS9_ALL_tCTN <- MBES_CAS9_ALL_mean[,-c(3,4,5)]
names(MBES_CAS9_ALL_tCTN)[2] <- "editing"
MBES_CAS9_ALL_tCTN$editing_type <- "C>T"
MBES_CAS9_ALL_tCAN <- MBES_CAS9_ALL_mean[,-c(2,4,5)]
names(MBES_CAS9_ALL_tCAN)[2] <- "editing"
MBES_CAS9_ALL_tCAN$editing_type <- "C>A"
MBES_CAS9_ALL_tCGN <- MBES_CAS9_ALL_mean[,-c(2,3,5)]
names(MBES_CAS9_ALL_tCGN)[2] <- "editing"
MBES_CAS9_ALL_tCGN$editing_type <- "C>G"
MBES_CAS9_ALL_stack <- rbind(MBES_CAS9_ALL_tCTN, MBES_CAS9_ALL_tCAN, MBES_CAS9_ALL_tCGN)
MBES_CAS9_ALL_stack <- MBES_CAS9_ALL_stack[complete.cases(MBES_CAS9_ALL_stack), ]
```

Repeat for each of the conditions (enzymes) included in the analysis

```{r echo=FALSE, message=FALSE, warning=FALSE}
# RA2
# Calculate mean percentages for TARGET data
MDA231_MBES_RA2$percent_tCT = (MDA231_MBES_RA2$percent_tCT_REP1 + MDA231_MBES_RA2$percent_tCT_REP2)/2
MDA231_MBES_RA2$percent_tCTN = (MDA231_MBES_RA2$percent_tCTN_REP1 + MDA231_MBES_RA2$percent_tCTN_REP2)/2
MDA231_MBES_RA2$percent_tCAN = (MDA231_MBES_RA2$percent_tCAN_REP1 + MDA231_MBES_RA2$percent_tCAN_REP2)/2
MDA231_MBES_RA2$percent_tCGN = (MDA231_MBES_RA2$percent_tCGN_REP1 + MDA231_MBES_RA2$percent_tCGN_REP2)/2
MDA231_MBES_RA2$percent_indel = (MDA231_MBES_RA2$percent_indel_REP1 + MDA231_MBES_RA2$percent_indel_REP2)/2
MDA231_MBES_RA2$percent_editing = (MDA231_MBES_RA2$percent_tCTN + MDA231_MBES_RA2$percent_tCGN +
                                          MDA231_MBES_RA2$percent_tCAN + MDA231_MBES_RA2$percent_indel)
MDA231_MBES_RA2$percent_BE = (MDA231_MBES_RA2$percent_tCTN + MDA231_MBES_RA2$percent_tCGN +
                                          MDA231_MBES_RA2$percent_tCAN)
# Calculate mean percentages for ALL data
MDA231_MBES_RA2_ALL$percent_tCTN = (MDA231_MBES_RA2_ALL$percent_tCTN_REP1 + MDA231_MBES_RA2_ALL$percent_tCTN_REP2)/2
MDA231_MBES_RA2_ALL$percent_tCAN = (MDA231_MBES_RA2_ALL$percent_tCAN_REP1 + MDA231_MBES_RA2_ALL$percent_tCAN_REP2)/2
MDA231_MBES_RA2_ALL$percent_tCGN = (MDA231_MBES_RA2_ALL$percent_tCGN_REP1 + MDA231_MBES_RA2_ALL$percent_tCGN_REP2)/2
MDA231_MBES_RA2_ALL$percent_BE = (MDA231_MBES_RA2_ALL$percent_tCTN + MDA231_MBES_RA2_ALL$percent_tCGN +
                                          MDA231_MBES_RA2_ALL$percent_tCAN)
# Filter to 100+ reads/guide and remove replicate data
MBES_RA2_filtered <- MDA231_MBES_RA2 %>% filter(total_REP1 > 99 & total_REP2 >99)
MBES_RA2_ALL_filtered <- MDA231_MBES_RA2_ALL %>% filter(total_REP1 > 99 & total_REP2 >99)
MBES_RA2_mean <- MBES_RA2_filtered[ ,-c(2:23)]
MBES_RA2_ALL_mean <- MBES_RA2_ALL_filtered[ ,-c(5:22)]
MBES_RA2_ALL_mean <- MBES_RA2_ALL_mean[ ,c(1,5:8,2,3,4)]
# Create separate mean file, rename columns, add variable and enzyme annoation
MBES_RA2_mean_ann <- MBES_RA2_filtered[ ,-c(2:23)]
MBES_RA2_mean_ann <- list(MBES_RA2_mean_ann,MBES_variables) %>% 
  reduce(full_join, by = 'guide_ID')
MBES_RA2_mean_ann$enzyme <- "FNLS"
MBES_RA2_ALL_mean$enzyme <- "FNLS"
MBES_RA2_mean_ann$cell_line <- "MDA231"
MBES_RA2_ALL_mean$cell_line <- "MDA231"
# Split by editing type
MBES_RA2_any_editing <- MBES_RA2_mean_ann[,-c(2,3,4,5,7)]
names(MBES_RA2_any_editing)[2] <- "editing"
MBES_RA2_any_editing$editing_type <- "all"
MBES_RA2_tCTN <- MBES_RA2_mean_ann[,-c(3,4,5,6,7)]
names(MBES_RA2_tCTN)[2] <- "editing"
MBES_RA2_tCTN$editing_type <- "C>T"
MBES_RA2_tCAN <- MBES_RA2_mean_ann[,-c(2,4,5,6,7)]
names(MBES_RA2_tCAN)[2] <- "editing"
MBES_RA2_tCAN$editing_type <- "C>A"
MBES_RA2_tCGN <- MBES_RA2_mean_ann[,-c(2,3,5,6,7)]
names(MBES_RA2_tCGN)[2] <- "editing"
MBES_RA2_tCGN$editing_type <- "C>G"
MBES_RA2_stack <- rbind(MBES_RA2_tCTN,MBES_RA2_tCAN,MBES_RA2_tCGN)
MBES_RA2_stack <- MBES_RA2_stack[complete.cases(MBES_RA2_stack), ]

# Add PAM_class, nucleotide context and cytosine position information to ALL data
MBES_RA2_ALL_mean$PAM_class <- ifelse(grepl('GG$', MBES_RA2_ALL_mean$PAM), "NGG", 
                         ifelse(grepl('GT$', MBES_RA2_ALL_mean$PAM), "NGT",
                                ifelse(grepl('GC$', MBES_RA2_ALL_mean$PAM), "NGC",
                                       ifelse(grepl('GA$', MBES_RA2_ALL_mean$PAM), "NGA",
                                              ifelse(grepl('AG$', MBES_RA2_ALL_mean$PAM), "NAG",
                                                     ifelse(grepl('TG$', MBES_RA2_ALL_mean$PAM), "NNG",
                                                            ifelse(grepl('CG$', MBES_RA2_ALL_mean$PAM), "NNG",
                                                                   ifelse(grepl('^GA', MBES_RA2_ALL_mean$PAM), "GAN", "other"))))))))
colnames(MBES_RA2_ALL_mean)[8] <- "nucleotide_context"
MBES_RA2_ALL_mean$dinucleotide_context <- substr(MBES_RA2_ALL_mean$nucleotide_context, 2,3)
MBES_RA2_ALL_mean$trinucleotide_context <- substr(MBES_RA2_ALL_mean$nucleotide_context, 2,4)
MBES_RA2_ALL_mean$adj_cytosine_position <- ifelse(MBES_RA2_ALL_mean$cytosine_position <10, MBES_RA2_ALL_mean$cytosine_position -10, MBES_RA2_ALL_mean$cytosine_position -9)
MBES_RA2_ALL_mean$guide_ID_temp <- as.factor(paste(MBES_RA2_ALL_mean$guide_ID, MBES_RA2_ALL_mean$cytosine_position, sep = "_"))
MBES_RA2_ALL_mean$guide_ID <- NULL
MBES_RA2_ALL_mean <- MBES_RA2_ALL_mean[ ,c(14,1:13)]
colnames(MBES_RA2_ALL_mean)[1] <- "guide_ID"
# Split by editing type
MBES_RA2_ALL_BE <- MBES_RA2_ALL_mean[,-c(2,3,4)]
names(MBES_RA2_ALL_BE)[2] <- "editing"
MBES_RA2_ALL_BE$editing_type <- "BE"
MBES_RA2_ALL_tCTN <- MBES_RA2_ALL_mean[,-c(3,4,5)]
names(MBES_RA2_ALL_tCTN)[2] <- "editing"
MBES_RA2_ALL_tCTN$editing_type <- "C>T"
MBES_RA2_ALL_tCAN <- MBES_RA2_ALL_mean[,-c(2,4,5)]
names(MBES_RA2_ALL_tCAN)[2] <- "editing"
MBES_RA2_ALL_tCAN$editing_type <- "C>A"
MBES_RA2_ALL_tCGN <- MBES_RA2_ALL_mean[,-c(2,3,5)]
names(MBES_RA2_ALL_tCGN)[2] <- "editing"
MBES_RA2_ALL_tCGN$editing_type <- "C>G"
MBES_RA2_ALL_stack <- rbind(MBES_RA2_ALL_tCTN,MBES_RA2_ALL_tCAN,MBES_RA2_ALL_tCGN)
MBES_RA2_ALL_stack <- MBES_RA2_ALL_stack[complete.cases(MBES_RA2_ALL_stack), ]

# F2X
# Calculate mean percentages for TARGET data
MDA231_MBES_F2X$percent_tCT = (MDA231_MBES_F2X$percent_tCT_REP1 + MDA231_MBES_F2X$percent_tCT_REP2)/2
MDA231_MBES_F2X$percent_tCTN = (MDA231_MBES_F2X$percent_tCTN_REP1 + MDA231_MBES_F2X$percent_tCTN_REP2)/2
MDA231_MBES_F2X$percent_tCAN = (MDA231_MBES_F2X$percent_tCAN_REP1 + MDA231_MBES_F2X$percent_tCAN_REP2)/2
MDA231_MBES_F2X$percent_tCGN = (MDA231_MBES_F2X$percent_tCGN_REP1 + MDA231_MBES_F2X$percent_tCGN_REP2)/2
MDA231_MBES_F2X$percent_indel = (MDA231_MBES_F2X$percent_indel_REP1 + MDA231_MBES_F2X$percent_indel_REP2)/2
MDA231_MBES_F2X$percent_editing = (MDA231_MBES_F2X$percent_tCTN + MDA231_MBES_F2X$percent_tCGN +
                                          MDA231_MBES_F2X$percent_tCAN + MDA231_MBES_F2X$percent_indel)
MDA231_MBES_F2X$percent_BE = (MDA231_MBES_F2X$percent_tCTN + MDA231_MBES_F2X$percent_tCGN +
                                          MDA231_MBES_F2X$percent_tCAN)
# Calculate mean percentages for ALL data
MDA231_MBES_F2X_ALL$percent_tCTN = (MDA231_MBES_F2X_ALL$percent_tCTN_REP1 + MDA231_MBES_F2X_ALL$percent_tCTN_REP2)/2
MDA231_MBES_F2X_ALL$percent_tCAN = (MDA231_MBES_F2X_ALL$percent_tCAN_REP1 + MDA231_MBES_F2X_ALL$percent_tCAN_REP2)/2
MDA231_MBES_F2X_ALL$percent_tCGN = (MDA231_MBES_F2X_ALL$percent_tCGN_REP1 + MDA231_MBES_F2X_ALL$percent_tCGN_REP2)/2
MDA231_MBES_F2X_ALL$percent_BE = (MDA231_MBES_F2X_ALL$percent_tCTN + MDA231_MBES_F2X_ALL$percent_tCGN +
                                          MDA231_MBES_F2X_ALL$percent_tCAN)
# Filter to 100+ reads/guide and remove replicate data
MBES_F2X_filtered <- MDA231_MBES_F2X %>% filter(total_REP1 > 99 & total_REP2 >99)
MBES_F2X_ALL_filtered <- MDA231_MBES_F2X_ALL %>% filter(total_REP1 > 99 & total_REP2 >99)
MBES_F2X_mean <- MBES_F2X_filtered[ ,-c(2:23)]
MBES_F2X_ALL_mean <- MBES_F2X_ALL_filtered[ ,-c(5:22)]
MBES_F2X_ALL_mean <- MBES_F2X_ALL_mean[ ,c(1,5:8,2,3,4)]
# Create separate mean file, rename columns, add variable and enzyme annoation
MBES_F2X_mean_ann <- MBES_F2X_filtered[ ,-c(2:23)]
MBES_F2X_mean_ann <- list(MBES_F2X_mean_ann,MBES_variables) %>% 
  reduce(full_join, by = 'guide_ID')
MBES_F2X_mean_ann$enzyme <- "F2X"
MBES_F2X_ALL_mean$enzyme <- "F2X"
MBES_F2X_mean_ann$cell_line <- "MDA231"
MBES_F2X_ALL_mean$cell_line <- "MDA231"
# Split by editing type
MBES_F2X_any_editing <- MBES_F2X_mean_ann[,-c(2,3,4,5,7)]
names(MBES_F2X_any_editing)[2] <- "editing"
MBES_F2X_any_editing$editing_type <- "all"
MBES_F2X_tCTN <- MBES_F2X_mean_ann[,-c(3,4,5,6,7)]
names(MBES_F2X_tCTN)[2] <- "editing"
MBES_F2X_tCTN$editing_type <- "C>T"
MBES_F2X_tCAN <- MBES_F2X_mean_ann[,-c(2,4,5,6,7)]
names(MBES_F2X_tCAN)[2] <- "editing"
MBES_F2X_tCAN$editing_type <- "C>A"
MBES_F2X_tCGN <- MBES_F2X_mean_ann[,-c(2,3,5,6,7)]
names(MBES_F2X_tCGN)[2] <- "editing"
MBES_F2X_tCGN$editing_type <- "C>G"
MBES_F2X_stack <- rbind(MBES_F2X_tCTN,MBES_F2X_tCAN,MBES_F2X_tCGN)
MBES_F2X_stack <- MBES_F2X_stack[complete.cases(MBES_F2X_stack), ]

# Add PAM_class, nucleotide context and cytosine position information to ALL data
MBES_F2X_ALL_mean$PAM_class <- ifelse(grepl('GG$', MBES_F2X_ALL_mean$PAM), "NGG", 
                         ifelse(grepl('GT$', MBES_F2X_ALL_mean$PAM), "NGT",
                                ifelse(grepl('GC$', MBES_F2X_ALL_mean$PAM), "NGC",
                                       ifelse(grepl('GA$', MBES_F2X_ALL_mean$PAM), "NGA",
                                              ifelse(grepl('AG$', MBES_F2X_ALL_mean$PAM), "NAG",
                                                     ifelse(grepl('TG$', MBES_F2X_ALL_mean$PAM), "NNG",
                                                            ifelse(grepl('CG$', MBES_F2X_ALL_mean$PAM), "NNG",
                                                                   ifelse(grepl('^GA', MBES_F2X_ALL_mean$PAM), "GAN", "other"))))))))
colnames(MBES_F2X_ALL_mean)[8] <- "nucleotide_context"
MBES_F2X_ALL_mean$dinucleotide_context <- substr(MBES_F2X_ALL_mean$nucleotide_context, 2,3)
MBES_F2X_ALL_mean$trinucleotide_context <- substr(MBES_F2X_ALL_mean$nucleotide_context, 2,4)
MBES_F2X_ALL_mean$adj_cytosine_position <- ifelse(MBES_F2X_ALL_mean$cytosine_position <10, MBES_F2X_ALL_mean$cytosine_position -10, MBES_F2X_ALL_mean$cytosine_position -9)
MBES_F2X_ALL_mean$guide_ID_temp <- as.factor(paste(MBES_F2X_ALL_mean$guide_ID, MBES_F2X_ALL_mean$cytosine_position, sep = "_"))
MBES_F2X_ALL_mean$guide_ID <- NULL
MBES_F2X_ALL_mean <- MBES_F2X_ALL_mean[ ,c(14,1:13)]
colnames(MBES_F2X_ALL_mean)[1] <- "guide_ID"
# Split by editing type
MBES_F2X_ALL_BE <- MBES_F2X_ALL_mean[,-c(2,3,4)]
names(MBES_F2X_ALL_BE)[2] <- "editing"
MBES_F2X_ALL_BE$editing_type <- "BE"
MBES_F2X_ALL_tCTN <- MBES_F2X_ALL_mean[,-c(3,4,5)]
names(MBES_F2X_ALL_tCTN)[2] <- "editing"
MBES_F2X_ALL_tCTN$editing_type <- "C>T"
MBES_F2X_ALL_tCAN <- MBES_F2X_ALL_mean[,-c(2,4,5)]
names(MBES_F2X_ALL_tCAN)[2] <- "editing"
MBES_F2X_ALL_tCAN$editing_type <- "C>A"
MBES_F2X_ALL_tCGN <- MBES_F2X_ALL_mean[,-c(2,3,5)]
names(MBES_F2X_ALL_tCGN)[2] <- "editing"
MBES_F2X_ALL_tCGN$editing_type <- "C>G"
MBES_F2X_ALL_stack <- rbind(MBES_F2X_ALL_tCTN,MBES_F2X_ALL_tCAN,MBES_F2X_ALL_tCGN)
MBES_F2X_ALL_stack <- MBES_F2X_ALL_stack[complete.cases(MBES_F2X_ALL_stack), ]

# FNLSNG
# Calculate mean percentages for TARGET data
MDA231_MBES_FNLSNG$percent_tCT = (MDA231_MBES_FNLSNG$percent_tCT_REP1 + MDA231_MBES_FNLSNG$percent_tCT_REP2)/2
MDA231_MBES_FNLSNG$percent_tCTN = (MDA231_MBES_FNLSNG$percent_tCTN_REP1 + MDA231_MBES_FNLSNG$percent_tCTN_REP2)/2
MDA231_MBES_FNLSNG$percent_tCAN = (MDA231_MBES_FNLSNG$percent_tCAN_REP1 + MDA231_MBES_FNLSNG$percent_tCAN_REP2)/2
MDA231_MBES_FNLSNG$percent_tCGN = (MDA231_MBES_FNLSNG$percent_tCGN_REP1 + MDA231_MBES_FNLSNG$percent_tCGN_REP2)/2
MDA231_MBES_FNLSNG$percent_indel = (MDA231_MBES_FNLSNG$percent_indel_REP1 + MDA231_MBES_FNLSNG$percent_indel_REP2)/2
MDA231_MBES_FNLSNG$percent_editing = (MDA231_MBES_FNLSNG$percent_tCTN + MDA231_MBES_FNLSNG$percent_tCGN +
                                          MDA231_MBES_FNLSNG$percent_tCAN + MDA231_MBES_FNLSNG$percent_indel)
MDA231_MBES_FNLSNG$percent_BE = (MDA231_MBES_FNLSNG$percent_tCTN + MDA231_MBES_FNLSNG$percent_tCGN +
                                          MDA231_MBES_FNLSNG$percent_tCAN)
# Calculate mean percentages for ALL data
MDA231_MBES_FNLSNG_ALL$percent_tCTN = (MDA231_MBES_FNLSNG_ALL$percent_tCTN_REP1 + MDA231_MBES_FNLSNG_ALL$percent_tCTN_REP2)/2
MDA231_MBES_FNLSNG_ALL$percent_tCAN = (MDA231_MBES_FNLSNG_ALL$percent_tCAN_REP1 + MDA231_MBES_FNLSNG_ALL$percent_tCAN_REP2)/2
MDA231_MBES_FNLSNG_ALL$percent_tCGN = (MDA231_MBES_FNLSNG_ALL$percent_tCGN_REP1 + MDA231_MBES_FNLSNG_ALL$percent_tCGN_REP2)/2
MDA231_MBES_FNLSNG_ALL$percent_BE = (MDA231_MBES_FNLSNG_ALL$percent_tCTN + MDA231_MBES_FNLSNG_ALL$percent_tCGN +
                                          MDA231_MBES_FNLSNG_ALL$percent_tCAN)
# Filter to 100+ reads/guide and remove replicate data
MBES_FNLSNG_filtered <- MDA231_MBES_FNLSNG %>% filter(total_REP1 > 99 & total_REP2 >99)
MBES_FNLSNG_ALL_filtered <- MDA231_MBES_FNLSNG_ALL %>% filter(total_REP1 > 99 & total_REP2 >99)
MBES_FNLSNG_mean <- MBES_FNLSNG_filtered[ ,-c(2:23)]
MBES_FNLSNG_ALL_mean <- MBES_FNLSNG_ALL_filtered[ ,-c(5:22)]
MBES_FNLSNG_ALL_mean <- MBES_FNLSNG_ALL_mean[ ,c(1,5:8,2,3,4)]
# Create separate mean file, rename columns, add variable and enzyme annoation
MBES_FNLSNG_mean_ann <- MBES_FNLSNG_filtered[ ,-c(2:23)]
MBES_FNLSNG_mean_ann <- list(MBES_FNLSNG_mean_ann,MBES_variables) %>% 
  reduce(full_join, by = 'guide_ID')
MBES_FNLSNG_mean_ann$enzyme <- "FNLSNG"
MBES_FNLSNG_ALL_mean$enzyme <- "FNLSNG"
MBES_FNLSNG_mean_ann$cell_line <- "MDA231"
MBES_FNLSNG_ALL_mean$cell_line <- "MDA231"
# Split by editing type
MBES_FNLSNG_any_editing <- MBES_FNLSNG_mean_ann[,-c(2,3,4,5,7)]
names(MBES_FNLSNG_any_editing)[2] <- "editing"
MBES_FNLSNG_any_editing$editing_type <- "all"
MBES_FNLSNG_tCTN <- MBES_FNLSNG_mean_ann[,-c(3,4,5,6,7)]
names(MBES_FNLSNG_tCTN)[2] <- "editing"
MBES_FNLSNG_tCTN$editing_type <- "C>T"
MBES_FNLSNG_tCAN <- MBES_FNLSNG_mean_ann[,-c(2,4,5,6,7)]
names(MBES_FNLSNG_tCAN)[2] <- "editing"
MBES_FNLSNG_tCAN$editing_type <- "C>A"
MBES_FNLSNG_tCGN <- MBES_FNLSNG_mean_ann[,-c(2,3,5,6,7)]
names(MBES_FNLSNG_tCGN)[2] <- "editing"
MBES_FNLSNG_tCGN$editing_type <- "C>G"
MBES_FNLSNG_stack <- rbind(MBES_FNLSNG_tCTN,MBES_FNLSNG_tCAN,MBES_FNLSNG_tCGN)
MBES_FNLSNG_stack <- MBES_FNLSNG_stack[complete.cases(MBES_FNLSNG_stack), ]

# Add PAM_class, nucleotide context and cytosine position information to ALL data
MBES_FNLSNG_ALL_mean$PAM_class <- ifelse(grepl('GG$', MBES_FNLSNG_ALL_mean$PAM), "NGG", 
                         ifelse(grepl('GT$', MBES_FNLSNG_ALL_mean$PAM), "NGT",
                                ifelse(grepl('GC$', MBES_FNLSNG_ALL_mean$PAM), "NGC",
                                       ifelse(grepl('GA$', MBES_FNLSNG_ALL_mean$PAM), "NGA",
                                              ifelse(grepl('AG$', MBES_FNLSNG_ALL_mean$PAM), "NAG",
                                                     ifelse(grepl('TG$', MBES_FNLSNG_ALL_mean$PAM), "NNG",
                                                            ifelse(grepl('CG$', MBES_FNLSNG_ALL_mean$PAM), "NNG",
                                                                   ifelse(grepl('^GA', MBES_FNLSNG_ALL_mean$PAM), "GAN", "other"))))))))
colnames(MBES_FNLSNG_ALL_mean)[8] <- "nucleotide_context"
MBES_FNLSNG_ALL_mean$dinucleotide_context <- substr(MBES_FNLSNG_ALL_mean$nucleotide_context, 2,3)
MBES_FNLSNG_ALL_mean$trinucleotide_context <- substr(MBES_FNLSNG_ALL_mean$nucleotide_context, 2,4)
MBES_FNLSNG_ALL_mean$adj_cytosine_position <- ifelse(MBES_FNLSNG_ALL_mean$cytosine_position <10,
                                                     MBES_FNLSNG_ALL_mean$cytosine_position -10,
                                                     MBES_FNLSNG_ALL_mean$cytosine_position -9)
MBES_FNLSNG_ALL_mean$guide_ID_temp <- as.factor(paste(MBES_FNLSNG_ALL_mean$guide_ID, MBES_FNLSNG_ALL_mean$cytosine_position, sep = "_"))
MBES_FNLSNG_ALL_mean$guide_ID <- NULL
MBES_FNLSNG_ALL_mean <- MBES_FNLSNG_ALL_mean[ ,c(14,1:13)]
colnames(MBES_FNLSNG_ALL_mean)[1] <- "guide_ID"
# Split by editing type
MBES_FNLSNG_ALL_BE <- MBES_FNLSNG_ALL_mean[,-c(2,3,4)]
names(MBES_FNLSNG_ALL_BE)[2] <- "editing"
MBES_FNLSNG_ALL_BE$editing_type <- "BE"
MBES_FNLSNG_ALL_tCTN <- MBES_FNLSNG_ALL_mean[,-c(3,4,5)]
names(MBES_FNLSNG_ALL_tCTN)[2] <- "editing"
MBES_FNLSNG_ALL_tCTN$editing_type <- "C>T"
MBES_FNLSNG_ALL_tCAN <- MBES_FNLSNG_ALL_mean[,-c(2,4,5)]
names(MBES_FNLSNG_ALL_tCAN)[2] <- "editing"
MBES_FNLSNG_ALL_tCAN$editing_type <- "C>A"
MBES_FNLSNG_ALL_tCGN <- MBES_FNLSNG_ALL_mean[,-c(2,3,5)]
names(MBES_FNLSNG_ALL_tCGN)[2] <- "editing"
MBES_FNLSNG_ALL_tCGN$editing_type <- "C>G"
MBES_FNLSNG_ALL_stack <- rbind(MBES_FNLSNG_ALL_tCTN,MBES_FNLSNG_ALL_tCAN,MBES_FNLSNG_ALL_tCGN)
MBES_FNLSNG_ALL_stack <- MBES_FNLSNG_ALL_stack[complete.cases(MBES_FNLSNG_ALL_stack), ]
```

Finally, join the data, calculate editing features like canonical (C>T) and non-canonical (C>A or C>G) ratios, and editing differences between different enzymes

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Join mean data, add variables and remove cases with NAs
MBES <- list(MBES_CAS9_mean,MBES_RA2_mean,MBES_F2X_mean,MBES_FNLSNG_mean,MBES_variables) %>% 
  reduce(full_join, by = 'guide_ID')
MBES <- MBES[complete.cases(MBES), ]
colnames(MBES) <- c("guide_ID", "Cas9_percent_tCT", "Cas9_percent_tCTN", "Cas9_percent_tCAN", "Cas9_percent_tCGN",
                                    "Cas9_percent_indels", "Cas9_percent_editing", "Cas9_percent_BE",
                                    "FNLS_percent_tCT", "FNLS_percent_tCTN", "FNLS_percent_tCAN", "FNLS_percent_tCGN",
                                    "FNLS_percent_indels", "FNLS_percent_editing", "FNLS_percent_BE",
                                    "F2X_percent_tCT","F2X_percent_tCTN", "F2X_percent_tCAN", "F2X_percent_tCGN",
                                    "F2X_percent_indels", "F2X_percent_editing", "F2X_percent_BE",
                                    "FNLSNG_percent_tCT","FNLSNG_percent_tCTN", "FNLSNG_percent_tCAN", "FNLSNG_percent_tCGN",
                                    "FNLSNG_percent_indels", "FNLSNG_percent_editing", "FNLSNG_percent_BE",
                    "protospacer", "cytosines_in_window", "PAM", "PAM_class", "target_position",
                    "bi_nucleotide_context", "tri_nucleotide_context", "symbol", "variant")

MBES_ALL <- list(MBES_RA2_ALL_mean, MBES_F2X_ALL_mean, MBES_FNLSNG_ALL_mean) %>% 
  reduce(full_join, by = 'guide_ID')
MBES_ALL <- MBES_ALL[complete.cases(MBES_ALL), ]
MBES_ALL <- MBES_ALL[ ,-c(6:14,19:27)]
colnames(MBES_ALL) <- c("guide_ID", "FNLS_percent_tCTN", "FNLS_percent_tCAN", "FNLS_percent_tCGN","FNLS_percent_BE",
                                    "F2X_percent_tCTN", "F2X_percent_tCAN", "F2X_percent_tCGN","F2X_percent_BE",
                                    "FNLSNG_percent_tCTN", "FNLSNG_percent_tCAN", "FNLSNG_percent_tCGN","FNLSNG_percent_BE",
                        "cytosine_position", "PAM","nucleotide_context","enzyme","cell_line","PAM_class","dinucleotide_context",
                        "trinucleotide_context", "adj_cytosine_position")

# Calculate editing ratios
MBES$F2X_FNLS_ratio <- (MBES$F2X_percent_tCTN / MBES$FNLS_percent_tCTN)
MBES$F2X_gain <- MBES$F2X_percent_tCTN - MBES$FNLS_percent_tCTN
MBES$NG_gain <- MBES$FNLSNG_percent_tCTN - MBES$FNLS_percent_tCTN
MBES_ALL$F2X_FNLS_ratio <- (MBES_ALL$F2X_percent_tCTN / MBES_ALL$FNLS_percent_tCTN)
MBES_ALL$F2X_gain <- MBES_ALL$F2X_percent_tCTN - MBES_ALL$FNLS_percent_tCTN
MBES_ALL$NG_gain <- MBES_ALL$FNLSNG_percent_tCTN - MBES_ALL$FNLS_percent_tCTN

# Rbind dataframes and remove rows with NAs
MBES_mean_stack <- rbind(MBES_CAS9_mean_ann,MBES_RA2_mean_ann,
                         MBES_F2X_mean_ann,MBES_FNLSNG_mean_ann)
MBES_mean_stack <- MBES_mean_stack[complete.cases(MBES_mean_stack), ]
MBES_stack_5percent_filter <- MBES_mean_stack %>% filter(percent_tCTN > 5)
MBES_stack_1percent_filter <- MBES_mean_stack %>% filter(percent_tCTN > 1)
MBES_stack_5percent_filter$GvsT_ratio = MBES_stack_5percent_filter$percent_tCGN/MBES_stack_5percent_filter$percent_tCTN
MBES_stack_5percent_filter$AvsT_ratio = MBES_stack_5percent_filter$percent_tCAN/MBES_stack_5percent_filter$percent_tCTN
# ALL data
MBES_ALL_stack <- rbind(MBES_RA2_ALL_mean,
                         MBES_F2X_ALL_mean,MBES_FNLSNG_ALL_mean)
MBES_ALL_stack <- MBES_ALL_stack[complete.cases(MBES_ALL_stack), ]
MBES_ALL_stack_2percent_filter <- MBES_ALL_stack %>% filter(percent_tCTN > 2)
MBES_ALL_stack_2percent_filter$GvsT_ratio = MBES_ALL_stack_2percent_filter$percent_tCGN/MBES_ALL_stack_2percent_filter$percent_tCTN
MBES_ALL_stack_2percent_filter$AvsT_ratio = MBES_ALL_stack_2percent_filter$percent_tCAN/MBES_ALL_stack_2percent_filter$percent_tCTN

MBES_ALL_stack_5percent_filter <- MBES_ALL_stack %>% filter(percent_tCTN > 5)
MBES_ALL_stack_5percent_filter$GvsT_ratio = MBES_ALL_stack_5percent_filter$percent_tCGN/MBES_ALL_stack_5percent_filter$percent_tCTN
MBES_ALL_stack_5percent_filter$AvsT_ratio = MBES_ALL_stack_5percent_filter$percent_tCAN/MBES_ALL_stack_5percent_filter$percent_tCTN
# Calculate mean editing efficiencies across each cytosine position, separate by PAM, enzyme and dinucleotide context
MBES_percent_BE_mean <- aggregate(percent_BE ~ adj_cytosine_position+PAM_class+enzyme+dinucleotide_context, data = MBES_ALL_stack, mean)
MBES_percent_tCTN_mean <- aggregate(percent_tCTN ~ adj_cytosine_position+PAM_class+enzyme+dinucleotide_context, data = MBES_ALL_stack, mean)
MBES_percent_tCGN_mean <- aggregate(percent_tCGN ~ adj_cytosine_position+PAM_class+enzyme+dinucleotide_context, data = MBES_ALL_stack, mean)
MBES_percent_tCAN_mean <- aggregate(percent_tCAN ~ adj_cytosine_position+PAM_class+enzyme+dinucleotide_context, data = MBES_ALL_stack, mean)
```

Write the table to a .csv file 

```{r echo=TRUE, message=FALSE, warning=FALSE}
write_csv(MBES, "~/Box Sync/BE_sensor/MDA231/results/MBES_MDA231.csv")
write_csv(MBES_ALL, "~/Box Sync/BE_sensor/MDA231/results/MBES_ALL_MDA231.csv")
```

<p style="font-family: Arial; font-size:18pt; font-style:bold">
    Plot the data
</p>
Calculate and plot Pearson correlation coefficients for target cytosine editing within each replicate. Save .png files to working directory

```{r echo=TRUE, message=FALSE, warning=FALSE, fig.width=16,fig.height=4}
a <- ggscatter(MBES_RA2_filtered, x = "percent_tCTN_REP1", y = "percent_tCTN_REP2", 
          add = "reg.line", conf.int = TRUE, alpha = 0.3, color = "steelblue4", 
          cor.coef = TRUE, cor.method = "pearson",
          title = "MDA231: MBES FNLS replicates",
          xlab = "FNLS %C>T editing (REP1)", 
          ylab = "FNLS %C>T editing (REP2)")+
  theme_bw(base_size = 8)+
  xlim(0,80)+
  ylim(0,80)+
  ggsave("MDA231_MBES_RA2_tCTN_replicates.png", dpi = 300, width = 10, height = 10, units = "cm")
# F2X
b <- ggscatter(MBES_F2X_filtered, x = "percent_tCTN_REP1", y = "percent_tCTN_REP2", 
          add = "reg.line", conf.int = TRUE, alpha = 0.3, color = "steelblue4", fill = "grey50",
          cor.coef = TRUE, cor.method = "pearson",
          title = "MDA231: MBES F2X replicates",
          xlab = "F2X %C>T editing (REP1)",
          ylab = "F2X %C>T editing (REP2)")+
  theme_bw(base_size = 8)+
  xlim(0,80)+
  ylim(0,80)+
  ggsave("MDA231_MBES_F2X_tCTN_replicates.png", dpi = 300, width = 10, height = 10, units = "cm")
# FNLS-NG
c <- ggscatter(MBES_FNLSNG_filtered, x = "percent_tCTN_REP1", y = "percent_tCTN_REP2", 
          add = "reg.line", conf.int = TRUE, alpha = 0.3, color = "steelblue4", 
          cor.coef = TRUE, cor.method = "pearson",
          title = "MDA231: MBES FNLS-NG replicates",
          xlab = "FNLS-NG %C>T editing (REP1)", 
          ylab = "FNLS-NG %C>T editing (REP2)")+
  theme_bw(base_size = 8)+
  xlim(0,80)+
  ylim(0,80)+
  ggsave("MDA231_MBES_NG_tCTN_replicates.png", dpi = 300, width = 10, height = 10, units = "cm")
# CAS9
d <- ggscatter(MBES_CAS9_filtered, x = "percent_tCTN_REP1", y = "percent_tCTN_REP2", 
          add = "reg.line", conf.int = TRUE, alpha = 0.3, color = "steelblue4", 
          cor.coef = TRUE, cor.method = "pearson",
          title = "MDA231: MBES CAS9 replicates",
          xlab = "FNLS-NG %C>T editing (REP1)", 
          ylab = "FNLS-NG %C>T editing (REP2)")+
  theme_bw(base_size = 8)+
  xlim(0,80)+
  ylim(0,80)+
  ggsave("MDA231_MBES_CAS9_tCTN_replicates.png", dpi = 300, width = 10, height = 10, units = "cm")

plot_grid(a,b,c,d, labels = c('A','B','C','D'), ncol = 4, label_size = 10)
```
```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=16,fig.height=4}
a <- ggscatter(MBES_RA2_ALL_filtered, x = "percent_tCTN_REP1", y = "percent_tCTN_REP2", 
          add = "reg.line", conf.int = TRUE, alpha = 0.3, color = "steelblue4", 
          cor.coef = TRUE, cor.method = "pearson",
          title = "MDA231: MBES-ALL FNLS replicates",
          xlab = "FNLS %C>T editing (REP1)", 
          ylab = "FNLS % C>T editing (REP2)")+
  theme_bw(base_size = 8)+
  xlim(0,80)+
  ylim(0,80)+
  ggsave("MDA231_MBES_RA2_tCTN_replicates.png", dpi = 300, width = 10, height = 10, units = "cm")
# F2X
b <- ggscatter(MBES_F2X_ALL_filtered, x = "percent_tCTN_REP1", y = "percent_tCTN_REP2", 
          add = "reg.line", conf.int = TRUE, alpha = 0.3, color = "steelblue4", fill = "grey50",
          cor.coef = TRUE, cor.method = "pearson",
          title = "MDA231: MBES-ALL F2X replicates",
          xlab = "F2X %C>T editing (REP1)",
          ylab = "F2X % C>T editing (REP2)")+
  theme_bw(base_size = 8)+
  xlim(0,80)+
  ylim(0,80)+
  ggsave("MDA231_MBES_F2X_tCTN_replicates.png", dpi = 300, width = 10, height = 10, units = "cm")
# FNLS-NG
c <- ggscatter(MBES_FNLSNG_ALL_filtered, x = "percent_tCTN_REP1", y = "percent_tCTN_REP2", 
          add = "reg.line", conf.int = TRUE, alpha = 0.3, color = "steelblue4", 
          cor.coef = TRUE, cor.method = "pearson",
          title = "MDA231: MBES-ALL FNLS-NG replicates",
          xlab = "FNLS-NG %C>T editing (REP1)", 
          ylab = "FNLS-NG %C>T editing (REP2)")+
  theme_bw(base_size = 8)+
  xlim(0,80)+
  ylim(0,80)+
  ggsave("MDA231_MBES_NG_tCTN_replicates.png", dpi = 300, width = 10, height = 10, units = "cm")
# CAS9
d <- ggscatter(MBES_CAS9_ALL_filtered, x = "percent_tCTN_REP1", y = "percent_tCTN_REP2", 
          add = "reg.line", conf.int = TRUE, alpha = 0.3, color = "steelblue4", 
          cor.coef = TRUE, cor.method = "pearson",
          title = "MDA231: MBES-ALL CAS9 replicates",
          xlab = "FNLS-NG %C>T editing (REP1)", 
          ylab = "FNLS-NG %C>T editing (REP2)")+
  theme_bw(base_size = 8)+
  xlim(0,80)+
  ylim(0,80)+
  ggsave("MDA231_MBES_CAS9_tCTN_replicates.png", dpi = 300, width = 10, height = 10, units = "cm")

plot_grid(a,b,c,d, labels = c('A','B','C','D'), ncol = 4, label_size = 10)
```

Compare base editing and indel frequency (only for target cytosine analysis)

```{r echo=TRUE, message=FALSE, warning=FALSE, fig.width=16,fig.height=4}
# RA2 (=FNLS)
e <- ggscatter(MBES_RA2_filtered, x = "percent_BE", y = "percent_indel", 
          add = "reg.line", conf.int = TRUE, alpha = 0.3, color = "steelblue4", 
          cor.coef = TRUE, cor.method = "pearson",
          title = "MDA231: FNLS BE vs indels",
          xlab = "Percent editing (FNLS)", 
          ylab = "Percent indels (FNLS)")+
  theme_bw()+
  xlim(0,80)+
  ylim(0,80)+
  ggsave("MDA231_MBES_RA2_editing_vs_indels.png", dpi = 300, width = 10, height = 10, units = "cm")
# F2X 
f <- ggscatter(MBES_F2X_filtered, x = "percent_BE", y = "percent_indel", 
          add = "reg.line", conf.int = TRUE, alpha = 0.3, color = "steelblue4", 
          cor.coef = TRUE, cor.method = "pearson",
          title = "MDA231: F2X BE vs indels",
          xlab = "Percent editing (F2X)", 
          ylab = "Percent indels (F2X)")+
  theme_bw()+
  xlim(0,80)+
  ylim(0,80)+
  ggsave("MDA231_MBES_F2X_editing_vs_indels.png", dpi = 300, width = 10, height = 10, units = "cm")
g <- ggscatter(MBES_FNLSNG_filtered, x = "percent_BE", y = "percent_indel", 
          add = "reg.line", conf.int = TRUE, alpha = 0.3, color = "steelblue4", 
          cor.coef = TRUE, cor.method = "pearson",
          title = "MDA231: FNLS-NG BE vs indels",
          xlab = "Percent editing (FNLS-NG)", 
          ylab = "Percent indels (FNLS-NG)")+
  theme_bw()+
  xlim(0,80)+
  ylim(0,80)+
  ggsave("MDA231_MBES_NG_editing_vs_indels.png", dpi = 300, width = 10, height = 10, units = "cm")
h <- ggscatter(MBES_CAS9_filtered, x = "percent_BE", y = "percent_indel", 
          add = "reg.line", conf.int = TRUE, alpha = 0.3, color = "steelblue4", 
          cor.coef = TRUE, cor.method = "pearson",
          title = "MDA231: CAS9 BE vs indels",
          xlab = "Percent editing (FNLS-NG)", 
          ylab = "Percent indels (FNLS-NG)")+
  theme_bw()+
  xlim(0,80)+
  ylim(0,80)+
  ggsave("MDA231_MBES_CAS9_editing_vs_indels.png", dpi = 300, width = 10, height = 10, units = "cm")

plot_grid(e,f,g,h, labels = c('A','B','C','D'), ncol = 4, label_size = 10)
```

Alternatively, you can plot the same data using `facet_grid` from the `MBES_mean_stack` dataframe

```{r echo=TRUE, message=FALSE, warning=FALSE, fig.width=12,fig.height=3.5}
ggscatter(MBES_mean_stack, x = "percent_BE", y = "percent_indel", 
          add = "reg.line", conf.int = TRUE, alpha = 0.3, color = "steelblue4", 
          cor.coef = TRUE, cor.method = "pearson",
          title = "Mouse library - MDA231",
          xlab = "Percent BE", 
          ylab = "Percent indels")+
  theme_bw(base_size = 10)+
  xlim(0,80)+
  ylim(0,80)+
  facet_grid(cols = vars(enzyme))+
  ggsave("MDA231_MBES_BE_vs_indels.png", 
         dpi = 300, width = 10, height = 10, units = "cm")
```

Compare enzymes for both target cytosine and ALL cytosine editing

```{r echo=TRUE, message=FALSE, warning=FALSE, fig.width=10,fig.height=7.5}
i <- ggscatter(MBES, x = "FNLS_percent_editing", y = "F2X_percent_editing", 
          add = "reg.line", conf.int = TRUE, alpha = 0.3, color = "FNLS_percent_tCTN", 
          cor.coef = TRUE, cor.method = "pearson",
          title = "MDA231: All editing - FNLS vs F2X",
          xlab = "FNLS % all editing", 
          ylab = "F2X % all editing")+
  theme_bw(base_size = 10)+
  xlim(0,100)+
  ylim(0,100)+ 
  scale_color_viridis(option = "A")+
  ggsave("MDA231_MBES_FNLSvsF2X_ALLediting.png", dpi = 300, width = 10, height = 10, units = "cm")
# RA2 vs F2X (BE)
j <- ggscatter(MBES, x = "FNLS_percent_BE", y = "F2X_percent_BE", 
          add = "reg.line", conf.int = TRUE, alpha = 0.3, color = "FNLS_percent_tCTN", 
          cor.coef = TRUE, cor.method = "pearson",
          title = "MDA231: base editing - FNLS vs F2X",
          xlab = "FNLS % base editing (C>T/A/G)", 
          ylab = "F2X % base editing (C>T/A/G)")+
  theme_bw(base_size = 10)+
  xlim(0,80)+
  ylim(0,80)+ 
  scale_color_viridis(option = "A")+
  ggsave("MDA231_MBES_FNLSvsF2X_ALLediting.png", dpi = 300, width = 10, height = 10, units = "cm")
# RA2 vs F2X (tCTN)
k <- ggscatter(MBES, x = "FNLS_percent_tCTN", y = "F2X_percent_tCTN", 
          add = "reg.line", conf.int = TRUE, alpha = 0.3, color = "FNLS_percent_tCTN", 
          cor.coef = TRUE, cor.method = "pearson",
          title = "MDA231: target C>T editing - FNLS vs F2X",
          xlab = "FNLS % C>T editing (REP1)", 
          ylab = "F2X % C>T editing (REP2)")+
  theme_bw(base_size = 10)+
  xlim(0,80)+
  ylim(0,80)+ 
  scale_color_viridis(option = "A")+
  ggsave("MDA231_MBES_FNLSvsF2X_tCTN.png", dpi = 300, width = 10, height = 10, units = "cm")
# RA2 vs F2X (indel)
l <- ggscatter(MBES, x = "FNLS_percent_indels", y = "F2X_percent_indels", 
          add = "reg.line", conf.int = TRUE, alpha = 0.3, color = "FNLS_percent_tCTN", 
          cor.coef = TRUE, cor.method = "pearson",
          title = "MDA231: indels - FNLS vs F2X",
          xlab = "FNLS indels", 
          ylab = "F2X indels")+
  theme_bw(base_size = 10)+
  xlim(0,80)+
  ylim(0,80)+ 
  scale_color_viridis(option = "A")+
  ggsave("MDA231_MBES_FNLSvsF2X_indel.png", dpi = 300, width = 10, height = 10, units = "cm")

plot_grid(i,j,k,l, labels = c('A','B','C','D'), ncol = 2, nrow = 2)
```

```{r echo=TRUE, message=FALSE, warning=FALSE, fig.width=10,fig.height=3.5}
# RA2 vs F2X (BE)
j <- ggscatter(MBES_ALL, x = "FNLS_percent_BE", y = "F2X_percent_BE", 
          add = "reg.line", conf.int = TRUE, alpha = 0.3, color = "adj_cytosine_position", 
          cor.coef = TRUE, cor.method = "pearson",
          title = "MDA231: ALL base editing - FNLS vs F2X",
          xlab = "FNLS % base editing (C>T/A/G)", 
          ylab = "F2X % base editing (C>T/A/G)")+
  theme_bw(base_size = 10)+
  xlim(0,100)+
  ylim(0,100)+ 
  scale_color_viridis(option = "A")+
  ggsave("MDA231_MBES_RA2vsF2X_ALLediting.png", dpi = 300, width = 10, height = 10, units = "cm")
# RA2 vs F2X (tCTN)
k <- ggscatter(MBES_ALL, x = "FNLS_percent_tCTN", y = "F2X_percent_tCTN", 
          add = "reg.line", conf.int = TRUE, alpha = 0.3, color = "adj_cytosine_position", 
          cor.coef = TRUE, cor.method = "pearson",
          title = "MDA231: ALL C>T editing - FNLS vs F2X",
          xlab = "FNLS % C>T editing", 
          ylab = "F2X % C>T editing")+
  theme_bw(base_size = 10)+
  xlim(0,80)+
  ylim(0,80)+ 
  scale_color_viridis(option = "A")+
  ggsave("MDA231_MBES_RA2vsF2X_CT.png", dpi = 300, width = 10, height = 10, units = "cm")

plot_grid(j,k, labels = c('A','B'), ncol = 2)
```

Compare base editing activity across target cytosine positions

```{r echo=TRUE, message=FALSE, warning=FALSE, fig.width=5,fig.height=4}
ggplot(MBES)+ 
  geom_point( aes(x=FNLS_percent_tCTN, y=F2X_percent_tCTN, color = target_position), alpha = 0.5)+
  xlim(0,70)+ 
  ylim(0,70)+
  geom_abline(intercept = 0, slope = 1, color="grey25", linetype="dashed", size=0.65)+
  theme_bw(base_size = 10)+
  scale_color_viridis(option = "B")+
  labs(title = "FNLS vs F2X (MBES-MDA231)",
       x = "Percent target editing - FNLS",
       y = "Percent target editing - F2X")+
  ggsave("MDA231_MBES_RA2vsF2X_tCTN_correlation.png", dpi = 300, width = 10, height = 10, units = "cm")
```

Base editing range across target cytosine positions x dinucleotide context

```{r echo=TRUE, message=FALSE, warning=FALSE, fig.width=6,fig.height=5}
# Compare types of editing for a single enzyme on same plot
# RA2
MBES_RA2_ALL_stack[MBES_RA2_ALL_stack$PAM_class == c("NGG"),] %>% 
  mutate(editing_type = fct_relevel(editing_type, levels=c("C>T","C>A","C>G"))) %>%
  ggplot( aes(x = adj_cytosine_position, y = editing, color = editing))+
  geom_jitter(size = .6, width = 0.1, alpha = 0.4)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))+
  ylim(0,80) + facet_grid(rows = vars(dinucleotide_context), cols = vars(editing_type))+
  theme_bw(base_size = 10)+
  labs(title = "FNLS editing - NGG ONLY",
       xlab = "Cytosine position",
       ylab = "Percent editing",
       color = NULL)+ 
  scale_color_viridis(option = "A", limits = c(0,80))
#F2X
MBES_F2X_ALL_stack[MBES_F2X_ALL_stack$PAM_class == c("NGG"),] %>% 
  mutate(editing_type = fct_relevel(editing_type, levels=c("C>T","C>A","C>G"))) %>%
  ggplot( aes(x = adj_cytosine_position, y = editing, color = editing))+
  geom_jitter(size = .6, width = 0.1, alpha = 0.4)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))+
  ylim(0,80) + facet_grid(rows = vars(dinucleotide_context), cols = vars(editing_type))+
  theme_bw(base_size = 10)+
  labs(title = "F2X editing - NGG ONLY",
       xlab = "Cytosine position",
       ylab = "Percent editing",
       color = NULL)+ 
  labs(color = NULL)+ scale_color_viridis(option = "A", limits = c(0,80))
#FNLS_NG
MBES_FNLSNG_ALL_stack[MBES_FNLSNG_ALL_stack$PAM_class == c("NGG"),] %>% 
  mutate(editing_type = fct_relevel(editing_type, levels=c("C>T","C>A","C>G"))) %>%
  ggplot( aes(x = adj_cytosine_position, y = editing, color = editing))+
  geom_jitter(size = .6, width = 0.1, alpha = 0.4)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))+
  ylim(0,80) + facet_grid(rows = vars(dinucleotide_context), cols = vars(editing_type))+
  theme_bw(base_size = 10)+
  labs(title = "FNLS-NG editing - NGG ONLY",
       xlab = "Cytosine position",
       ylab = "Percent editing",
       color = NULL)+ 
  labs(color = NULL)+ scale_color_viridis(option = "A", limits = c(0,80))
```

Editing range across enzyme and PAM class

```{r echo=TRUE, message=FALSE, warning=FALSE, fig.width=10,fig.height=6}
MBES_ALL_stack %>% 
  mutate(PAM_class = fct_relevel(PAM_class, levels=c("NGA","NGT","NGC","NGG","NAG","NNG","GAN"))) %>%
  mutate(enzyme = fct_relevel(enzyme, levels=c("FNLS","F2X","FNLSNG"))) %>%
  ggplot( aes(x = adj_cytosine_position, y = percent_tCTN, color = percent_tCTN))+
  geom_jitter(size = .25, width = 0.2, alpha = 0.6)+
  theme_bw(base_line_size = 0.25)+
  ylim(0,80) +
  labs(title = "C>T editing range (MBES-MDA231)",
       xlab = "Cytosine position",
       ylab = "Percent C>T editing",color = NULL)+
  scale_color_viridis(option = "A", limits = c(0,80))+
  facet_grid(rows = vars(enzyme), cols = vars(PAM_class))+
  ggsave("MDA231_MBES_tCTN_range.png", dpi = 300, width = 25, height = 15, units = "cm")
```

Alternatively, average BE activity across different cytosine positions can be visualized by heatmap. In this case, the window is restricted to positions 1-20 of the protospacer, as this encapsulates almost all of the editing events. Can use this approach to view all BE events, or just C>T, C>G, C>A

```{r echo=TRUE, message=FALSE, warning=FALSE, fig.width=10,fig.height=4}
# ALL BE
MBES_percent_BE_mean[MBES_percent_BE_mean$adj_cytosine_position >= 1 & MBES_percent_BE_mean$adj_cytosine_position <=20, ] %>%
  mutate(PAM_class = fct_relevel(PAM_class, levels=c("NGT","NGC","NGA","NGG","NAG","NNG","GAN"))) %>% 
  mutate(enzyme = fct_relevel(enzyme, levels=c("FNLS","F2X","FNLSNG"))) %>%
  mutate(dinucleotide_context = fct_relevel(dinucleotide_context, levels=c("AC","TC","CC","GC"))) %>%
  ggplot(aes(x = adj_cytosine_position, y = PAM_class, fill = percent_BE)) + 
  geom_tile() +
  theme_bw(base_size = 10)+
  scale_fill_viridis(option = "C", limits = c(0,100), na.value = "grey50")+
  facet_grid(rows = vars(enzyme), cols = vars(dinucleotide_context))
# C>T
MBES_percent_tCTN_mean[MBES_percent_tCTN_mean$adj_cytosine_position >= 1 & MBES_percent_tCTN_mean$adj_cytosine_position <=20, ] %>%
  mutate(PAM_class = fct_relevel(PAM_class, levels=c("NGT","NGC","NGA","NGG","NAG","NNG","GAN"))) %>% 
  mutate(enzyme = fct_relevel(enzyme, levels=c("FNLS","F2X","FNLSNG"))) %>%
  mutate(dinucleotide_context = fct_relevel(dinucleotide_context, levels=c("AC","TC","CC","GC"))) %>%
  ggplot(aes(x = adj_cytosine_position, y = PAM_class, fill = percent_tCTN)) + 
  geom_tile() +
  theme_bw(base_size = 10)+
  scale_fill_viridis(option = "C", limits = c(0,100), na.value = "grey50")+
  facet_grid(rows = vars(enzyme), cols = vars(dinucleotide_context))
# C>G
MBES_percent_tCGN_mean[MBES_percent_tCGN_mean$adj_cytosine_position >= 1 & MBES_percent_tCGN_mean$adj_cytosine_position <=20, ] %>%
  mutate(PAM_class = fct_relevel(PAM_class, levels=c("NGT","NGC","NGA","NGG","NAG","NNG","GAN"))) %>% 
  mutate(enzyme = fct_relevel(enzyme, levels=c("FNLS","F2X","FNLSNG"))) %>%
  mutate(dinucleotide_context = fct_relevel(dinucleotide_context, levels=c("AC","TC","CC","GC"))) %>%
  ggplot(aes(x = adj_cytosine_position, y = PAM_class, fill = percent_tCGN)) + 
  geom_tile() +
  theme_bw(base_size = 10)+
  scale_fill_viridis(option = "C", limits = c(0,15), na.value = "grey50")+
  facet_grid(rows = vars(enzyme), cols = vars(dinucleotide_context))
# C>A
MBES_percent_tCAN_mean[MBES_percent_tCAN_mean$adj_cytosine_position >= 1 & MBES_percent_tCAN_mean$adj_cytosine_position <=20, ] %>%
  mutate(PAM_class = fct_relevel(PAM_class, levels=c("NGT","NGC","NGA","NGG","NAG","NNG","GAN"))) %>% 
  mutate(enzyme = fct_relevel(enzyme, levels=c("FNLS","F2X","FNLSNG"))) %>%
  mutate(dinucleotide_context = fct_relevel(dinucleotide_context, levels=c("AC","TC","CC","GC"))) %>%
  ggplot(aes(x = adj_cytosine_position, y = PAM_class, fill = percent_tCAN)) + 
  geom_tile() +
  theme_bw(base_size = 10)+
  scale_fill_viridis(option = "C", limits = c(0,15), na.value = "grey50")+
  facet_grid(rows = vars(enzyme), cols = vars(dinucleotide_context))
```

Non-canonical editing by dinucleotide context

```{r echo=TRUE, message=FALSE, warning=FALSE, fig.width=8,fig.height=4.5}
# Boxplot with stats (editing type ratios)
MBES_ALL_stack_5percent_filter %>%
  mutate(dinucleotide_context = fct_relevel(dinucleotide_context, levels=c("AC","TC","CC","GC"))) %>%
  ggboxplot(x = "dinucleotide_context", y = "GvsT_ratio",
          color = "dinucleotide_context", 
          fill = "dinucleotide_context", 
          palette = "jco",
          alpha = 0.5,
          title = "C>G / C>T editing ratio (>5% C>T)",
          ylab = "C>G / C>T ratio",
          xlab = "dinucleotide context",
          ggtheme = theme_bw(base_size = 10))+
  facet_grid(cols = vars(enzyme))+
  stat_summary(fun.data = function(x) data.frame(y = c(-0.1),
                                                 label = paste(round(mean(x),2))), 
               geom="text", size = 3)+
    rotate_x_text()+
  stat_compare_means(comparisons = list(c("TC","AC"),c("TC","GC"),c("TC","CC"),
                                        c("AC","GC"),c("AC","CC"),c("GC","CC")))
# No stats
MBES_ALL_stack_5percent_filter %>%
  mutate(dinucleotide_context = fct_relevel(dinucleotide_context, levels=c("AC","TC","CC","GC"))) %>%
  ggboxplot(x = "dinucleotide_context", y = "GvsT_ratio",
          color = "dinucleotide_context", 
          fill = "dinucleotide_context", 
          palette = "jco",
          alpha = 0.5,
          title = "C>G / C>T editing ratio (>5% C>T)",
          ylab = "C>G / C>T ratio",
          xlab = "dinucleotide context",
          ggtheme = theme_bw(base_size = 10))+
  facet_grid(cols = vars(enzyme))+
  stat_summary(fun.data = function(x) data.frame(y = c(-0.1),
                                                 label = paste(round(mean(x),2))), 
               geom="text", size = 3)+
    rotate_x_text()

# C>A / C>T editing ratio
MBES_ALL_stack_5percent_filter %>%
  mutate(dinucleotide_context = fct_relevel(dinucleotide_context, levels=c("AC","TC","CC","GC"))) %>%
  ggboxplot(x = "dinucleotide_context",y = "AvsT_ratio",
          color = "dinucleotide_context", 
          fill = "dinucleotide_context", 
          palette = "jco",
          alpha = 0.5,
          title = "C>A / C>T editing ratio (>5% C>T)",
          ylab = "C>A / C>T ratio",
          xlab = "dinucleotide context",
          ggtheme = theme_bw(base_size = 10))+
  facet_grid(cols = vars(enzyme))+
  stat_summary(fun.data = function(x) data.frame(y = c(-0.1),
                                                 label = paste(round(mean(x),2))), 
               geom="text", size = 3)+
    rotate_x_text()+
  stat_compare_means(comparisons = list(c("TC","AC"),c("TC","GC"),c("TC","CC"),
                                        c("AC","GC"),c("AC","CC"),c("GC","CC")))
# No stats
MBES_ALL_stack_5percent_filter %>%
  mutate(dinucleotide_context = fct_relevel(dinucleotide_context, levels=c("AC","TC","CC","GC"))) %>%
  ggboxplot(x = "dinucleotide_context", y = "AvsT_ratio",
          color = "dinucleotide_context", 
          fill = "dinucleotide_context", 
          palette = "jco",
          alpha = 0.5,
          title = "C>A / C>T editing ratio (>5% C>T)",
          ylab = "C>A / C>T ratio",
          xlab = "dinucleotide context",
          ggtheme = theme_bw(base_size = 10))+
  facet_grid(cols = vars(enzyme))+
  stat_summary(fun.data = function(x) data.frame(y = c(-0.1),
                                                 label = paste(round(mean(x),2))), 
               geom="text", size = 3)+
    rotate_x_text()
```

